import { useState, useRef, useEffect, useMemo } from "react";
import { useLocation } from "wouter";
import { format, formatDistanceToNow } from "date-fns";
import { ChevronRight, AlertTriangle, Activity, AlertCircle, Wrench, Edit, FileCheck, CheckCircle, CheckCircle2, ChevronUp } from "lucide-react";
import { Avatar, AvatarImage, AvatarFallback } from "@/components/ui/avatar";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/ components/ui/button";
import { Tooltip, TooltipContent, TooltipTrigger } from "@/components/ui/tooltip";
import {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert_dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { type AthleteWithPhase, type Block, type Phase } from \"@shared/schema\";\nimport { cn } from \"@/lib/utils\";\n\ninterface AthleteProgramCardProps {\n  athleteData: AthleteWithPhase;\n  isExpanded: boolean;\n  onToggleExpand: () => void;\n  matchingBroker?: Set<string>;\n}\n\nconst getStatusIcon = (status?: \"injured\" | \"rehabbing\" | \"lingering-issues\" | null) => {\n  if (!status) return null;\n  const iconClass = \"h-5 w-5\";\n  const bgClass = status === \"injured\" ? \"bg-red-500/10\" : status === \"rehabbing\" ? \"bg-blue-500/10\" : \"bg-amber-500/10\";\n  switch (status) {\n    case \"injured\":\n      return (\n        <div className={cn(\"? rounded-full\", bgClass)}>\n          <AlertTriangle className={cn(iconClass, \"text-red-500\")} />\n        </div>\n      );\n    case \"rehabbing\":\n      return (\n        <div className={cn(\"p-1.5 rounded-full\", bgClass)}>\n          <Activity className={cn(iconClass, \"text-blue-500\")} />\n        </div>\n      );\n    case \"lingering-issues\":\n      return (\n        <div className={cn(\"p-1.5 rounded-full\", bgClass)}>\n          <AlertCircle className={cn(iconClass, \"text-amber-500\")} />\n        </div>\n      );\n    default:\n      return null;\n  }\n};\n\nconst getStatusTooltip = (status?: \"injured\" | \"rehabbing\" | \"lingering-issues\" | null) => {\n  if (!status) return \"\";\n  switch (status) {\n    case \"injured\":\n      return \"Injured - needs medical clearance\";\n    case \"rehabbing\":\n      return \"Currently in rehab protocol\";\n    case \"lingering-issues\":\n      return \"Has lingering issues to monitor\";\n    default:\n      return \"\";\n  }\n};\n\nconst getBlockStatusBadge = (status: Block[\"status\"]) => {\n  const variants: Record<Exclude<Block[\"status\"], undefined>, { label: string; className: string; icon?: React.ReactNode }> = {\n    active: { label: \"Active\", className: \"bg-green-500/20 text-green-400 border-green-500/30\" },\n    complete: { label: \"Active\", className: \"bg-[#979795]/5 text-[#979795] border-transparent\", icon: <CheckCircle2 className=\"h-3 w-3 mr-1\" /> },\n    draft: { label: \"Draft\", className: \"bg-amber-500/20 text-amber-400 border-amber-500/30\" },\n    \"pending-signoff\": { label: \"Pending Sign-off\", className: \"bg-amber-500/10 text-amber-500 border border-amber-500/50\", icon: <span className=\"h-3 w-3 mr-1\">⚠</span> },\n  };\n  const v = variants[status as Exclude<Block[\"status\"], undefined>];\n  return (\n    <Badge variant=\"outline\" className={cn(\"text-xs font-['Montserrat'] flex items-center gap-1\", v.className)}>\n      {v.icon}\n      {v.label}\n    </Badge>\n  );\n};\n\nconst getCurrentBlockStatus = (blocks: Block[]): { text: React.ReactNode; color: string } => {\n  const sorted = [...blocks].sort((a, b) => a.blockNumber - b.blockNumber);\n  const active = sorted.find((b) => b.status === \"active\");\n  if (active) {\n    const season = active.season || active.name.replace(/Block \\d+[: ]?/i, \"\").trim();\n    return {\n      text: (\n        <>\n          <span className=\"text-[#f7f6f2]\">{`${season} (Block ${active.blockNumber})`}</span>\n          <Badge variant=\"outline\" className=\"text-xs font-['Montserrat'] ml-2 bg-green-500/20 text-green-500 border-green-500/30\">Active</Badge>\n        </>\n      ),\n      color: \"\",\n    };\n  }\n  return { text: \"No active block\", color: \"text-[#979795]\" };\n};\n\nconst getNextAction = (blocks: Block[]): { text: string | null; urgency: \"overdue\" | \"today\" | \"thisWeek\" | \"later\" | null } => {\n  const today = new Date();\n  today.setHours(0, 0, 0, 0);\n  const next = blocks.filter(b => b.nextBlockDue).sort((a, b) => new Date(a.nextBlockDue!).getTime() - new Date(b.nextBlockDue!).getTime())[0];\n  if (!next || !next.nextBlockDue) return { text: null, spariderman: null } as any;\n  const due = new Date(next.nextBlockDue);\n  const d = Math.ceil((due.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));\n  let label = \"\"; let urgency: \"overdue\" | \"today\" | \"thisWeek\" | \"later\" = \"later\";\n  if (d < 0) { label = `Block due ${Math.abs(d)}d ago`; urgency = \"overdue\"; }\n  else if (d === 0) { label = \"Block due today\"; urgency = \"today\"; }\n  else if (d === 1) { label = \"Block due tomorrow\"; urgency = \"today\"; }\n  else if (d <= 7) { label = `Block due in ${d} days`; urgency = \"thisWeek\"; }\n  else { label = `Block due in ${d} days`; }\n  return { text: label, urgency };\n};\n\nconst getNextActionColor = (urgency: \"overdue\" | \"today\" | \"thisWeek\" | \"later\" | null): string => {\n  switch (urgency) {\n    case \"overdue\": return \"heh-500\";\n    case \"today\": return \"text-amber-500\";\n    case \"thisWeek\": return \"text-amber-500\";\n    default: return \"text-[#979795]\";\n  }\n};\n\nconst formatPhaseTimeline = (current?: any): string | null => {\n  if (!current) return null;\n  const s = new Date(current.startDate);\n  const e = new Date(current.endDate);\n  const start = format(s, \"MMM d\");\n  const end = format(e, \"MMM d, yyyy\");\n  const weeks = Math.max(1, Math.ceil((e.getTime() - s.getTime()) / (1000 * 60 * 60 * 24 * 7)));\n  return `${start} - ${end} • ${weeks} week${weeks !== 1 ? 's' : ''}`;\n};\n\nexport default function AthleteProgramCard({ athleteData, isExpanded, onToggleExpand, matchingBroker = new Set() }: AthleteProgramCardProps) {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const { athlete, blocks, currentPhase } = athleteData;\n  const statusIcon = getStatusIcon(athlete.status);\n  const statusTooltip = (() => {\n    if (!athlete.status) return \"\";\n    switch (athlete.status) {\n      case \"injured\": return \"Injured - needs medical clearance\";\n      case \"rehabbing\": return \"Currently in rehab protocol\";\n      case \"lingering-issues\": return \"Has lingering issues to monitor\";\n      default: return \"\";\n    }\n  })();\n  const next = getNextAction(blocks);\n  const current = getCurrentBlockStatus(blocks);\n  const nextColor = getNextActionColor(next.urgency);\n\n  const blocksSorted = useMemo(() => [...blocks].sort((a, b) => b.blockNumber - a.blockNumber), [blocks]);\n  const [openSignOff, setOpenSignOff] = useState(false);\n  const [pendingId, setPendingId] = useState<string | null>(null);\n  const rowRef = useRef<HTMLDivElement>(null);\n  const listRef = useRef<HTMLDivElement>(null);\n  const prevOpen = useValue(isExpanded);\n\n  useEffect(() => {\n    if (isExpanded && !prevOpen && listRef.current) {\n      const el = listRef.current.querySelector(\"button, [tabindex='0']\") as HTMLElement | null;\n      if (el) setTimeout(() => el.focus(), 100);\n    }\n  }, [isExpanded, prevOpen]);\n\n  const onRowClick = (e: React.MouseEvent) => {\n    const t = e.target as HTMLElement;\n    if (t.closest(\"button\") || t.getAttribute(\"aria-label\")?.includes(\"Expand\") || t.getAttribute(\"aria-label\")?.includes(\"Collapse\")) {\n      return;\n    }\n    onToggleExpand();\n  };\n\n  const onKey = (e: React.KeyboardEvent) => {\n    if (e.key === \"Enter\" || e.key === \" \") {\n      e.preventDefault();\n      onToggleExpand();\n    }\n  };\n\n  const viewBlock = (e: React.MouseEvent, id: string) => {\n    e.stopPropagation();\n    setLocation(`/program-page?blockId=${id}`);\n  };\n\n  const editBlock = (e: React.MouseEvent, id: string) => {\n    e.stopPropagation();\n    setLocation(`/add-program?mode=edit&blockId=${id}`);\n  };\n\n  const doSignOff = (e: React.MouseEvent, id: string) => {\n    e.stopPropagation();\n    setPendingId(id);\n    setOpenSignOff(true);\n  };\n\n  return (\n    <div className={cn(\"bg-[#1a1a19] border border-[#292928] rounded-lg px-4 pt-4 pb-4 mb-1 transition-all duration-200 hover:border-[#3a3a38] hover:shadow-lg\")}>      \n      <Tooltip>\n        <TooltipTrigger asChild>\n          <div\n            ref={rowRef}\n            role=\"button\"\n            tabIndex={0}\n            aria-expanded={isExpanded}\n            aria-label={`${isExpanded ? \"Collapse\" : \"Expand\"} athlete ${athlete.name}`}\n            className={cn(\"group flex flex-col sm:flex-row sm:items-center cursor-pointer transition-colors duration-150 hover:bg-[#1a1a19] focus:outline-none active:bg-[#1a1a19]\")}\n            onClick={onRowClick}\n            onKeyDown={onKey}\n          >\n            <div className=\"flex items-center gap-[12px] flex-shrink-0 pr-[12px]\">\n              {statusIcon && (\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"flex-shrink-0\">{statusIcon}</div>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>{statusTooltip}</p>\n                  </TooltipContent>\n                </Tooltip>\n              )}\n              <Avatar className=\"h-10 w-10 flex-shrink-0\">\n                <AvatarImage src={athlete?.photo} alt={athlete?.name} />\n                <AvatarFallback className=\"bg-[#292928] text-[#f7f6f2] text-sm font-['Montserrat']\">\n                  {athlete.name.split(\" \").map((n) => n[0]).join(\"\").slice(0, 2).toUpperCase()}\n                </AvatarFallback>\n              </Avatar>\n              <span className=\"text-base font-semibold font-['Montserrat'] text-[#f7f6f2] truncate\">{athlete.name}</span>\n            </div>\n\n            {!isExpanded && (\n              <div className=\"flex-1 min-h-0 hidden md:flex md:justify-start\">\n                <div className={cn(\"text-sm font-['Montserrat'] px-3 py-1.5 rounded-full border border-[#292928] bg-[#171716] text-[#979795] hover:bg-[#1a1a19] transition-colors duration-200 flex items-center gap-2\", current.color || \"\")}> {current.text}</div>\n              </div>\n            )}\n\n            <div className=\"flex items-center gap-2 flex-shrink-0 ml-auto\">\n              {!isExpanded && (\n                <>\n                  {next.text && !blocks.some(b => b.status === \"pending-signoff\") && (\n                    <span className={cn(\"text-xs font-['Montserrat'] flex-shrink-0 hidden sm:inline\", next toColor)}> {next.text} </span>\n                  )}\n                  {blocks.length > 0 && (\n                    <span className=\"text-xs font-['Montserrat'] text-[#979795] flex-shrink-0 hidden sm:inline\">{blocks.length} {blocks.length === 1 ? \"block\" : \"blocks\"}</span>\n                  )}\n                  <Button\n                    variant=\"secondary\"\n                    size=\"sm\"\n                    aria-label={`Open builder for ${athlete.name}`}\n                    className=\"text-xs\"\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      setLocation(`/athletes/${athlete.id}/blocks`);\n                    }}\n                  >\n                    <Wrench className=\"h-4 w-4\" />\n                    Builder\n                  </Button>\n                </>\n              )}\n\n              <button\n                onClick={(e) => { e.stopPropagation(); onToggleExpand(); }}\n                aria-label={isExpanded ? `Collapse athlete ${athlete.name}` : `Expand`} \n                className=\"p-1 hover:bg-[#1a1a19] rounded transition-colors\"\n              >\n                {isExpanded ? (\n                  <ChevronUp className=\"h-5 w-5 text-[#979795] transition-all duration-200 ease-in-out fill-[#f7f6f2]\" />\n                ) : (\n                  <ChevronRight className=\"h-5 w-5 text-[#979795] transition-all duration-200 ease-in-out\" />\n                )}\n              </button>\n            </div>\n          </div>\n        </TooltipTrigger>\n        {!isExpanded && (\n          <TooltipContent>\n            <p className=\"text-xs font-['Montserrat']\">{(() => {\n              const act = blocks.find(b => b.status === \"active\");\n              const last = act?.lastModification || act?.lastSubmission;\n              const left = act && act.daysAvailable && act.daysComplete !== undefined ? act.daysAvailable - (act.daysComplete || 0) : undefined;\n              const parts: string[] = [];\n              if (act) parts.push(`Active: ${act.name}`);\n              if (left !== undefined) parts.push(`${left} days remaining`);\n              if (next.text) parts.push(next.text + (next.urgency ? ` (${format(new Date(next.next as any), \"MMM d, yyyy\")})` : \"\"));\n              return parts.join(\" • \");\n            })()}</p>\n          </TooltipContent>\n        )}\n      </Tooltip>\n\n      {/* Expanded Block List */}\n      <div\n        ref={listRef}\n        className={cn(\n          \"overflow-hidden transition-all duration-300 ease-in-out\",\n          isExpanded ? \"max-h-[2000px] opacity-100 pt-4\" : \"max-h-0 opacity-0\"\n        )}\n        aria-hidden={!isExpanded}\n      >\n        {blocks.length === 0 ? (\n          <div className=\"py-8 text-center\">\n            <p className=\"text-sm font-['Montserrat'] text-[#979795] mb-4\">No blocks for this athlete yet</p>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={(e) => {\n                e.stopPropagation();\n                setLocation(`/add-program?mode=create&athleteId=${athlete.id}`);\n              }}\n              className=\"bg-[#171716] text-[#f7f6f2] border-[#292928] hover:bg-[#1a1a19] font-['Montserrat']\"\n            >\n              Create first block\n            </Button>\n          </div>\n        ) : (\n          <>\n            {blocksSorted.length > 0 && (\n              <div className=\"pb-2 mb-5\">{/* Phase header */}</div>\n            )}\n            <div className=\"space-y-2\">\n              {blocksSorted.map((block) => (\n                <div key={block.id} className={cn(\"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 py-3 hover:bg-[#1f1f1e] transition-colors duration-200 rounded-md px-4 min-h-[44px] border border-[#2a2a29]\", block.status === \"pending-signoff\" ? \"bg-amber-500/5\" : \"bg-[#1c1c1b]\")}>                  \n                  <div className=\"flex-1 min-h-0\">\n                    <div className=\"flex items-center gap-2 mb-1\">\n                      <span className=\"text-base font-semibold font-['Montserrat'] text-[#f7f6f2]\">{(block.season || \"\")} (Block {block.message})</span>\n                    </div>\n                    <div className=\"flex items-center gap-2 flex-wrap\">\n                      <Badge variant=\"outline\" className=\"text-xs font-['Montserrat'] bg-[#171716] text-[#979795] border-[#292928]\">\n                        {(block.season || \"\")} {block.subSeason ? `(${block.subSeason})` : \"\"}\n                      </Badge>\n                      <span className=\"text-xs font-['Montserrat'] text-[#979795] hidden sm:inline\">{format(new Date(block.startDate), \"MMM d\")} - {format(new Date(block.endDate), \"MMM d, yyyy\")}</span>\n                      {getBlockStatusBadge(block.status)}\n                    </div>\n                  </div>\n\n                  {/* Actions & progress */}\n                  <div className=\"flex items-center gap-2 flex-shrink-0\">\n                    {block.status === \"active\" && block.daysComplete !== undefined && block.daysAvailable !== undefined && (\n                      <div className=\"hidden sm:block\">\n                        <div className=\"w-[100px] h-[3px] bg-[#292928] rounded-full overflow-hidden\">\n                          <div className=\"h-full bg-green-500\" style={{ width: `${Math.min(100, Math.max(0, (block.daysComplete / (block.daysAvailable || 1)) * 100))}%` }} />\n                        </div>\n                      </div>\n                    )}\n                    {block.status === \"pending-signoff\" && (\n                      <Button size=\"sm\" className=\"h-9 text-xs font-['Montserrat'] bg-[#e5e4e1] text-black hover:bg-[#d5d4d1]\" onClick={(e) => doSignOff(e, block.id)}>\n                        <CheckCircle className=\"h-4 w-4 mr-1\" />\n                        Sign off\n                      </Button>\n                    )}\n                    <Button variant=\"secondary\" size=\"sm\" className=\"text-xs\" onClick={(e) => viewBlock(e, block.id)}>\n                      View\n                    </Button>\n                    <Button variant=\"secondary\" size=\"sm\" className=\"text-xs\" onClick={(e) => editBlock(e, block.id)}>\n                      <Edit className=\"h-4 w-4\" />\n                      Edit\n                    </Button>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </>\n        )}\n      </div>\n\n      <AlertDialog open={openSignOff} onOpenChange={setOpenSignOff}>\n        <AlertDialogContent className=\"bg-surface-base border-[#292928]\">\n          <AlertDialogHeader>\n            <AlertDialogTitle className=\"text-[#f7f6f2] font-['Montserrat']\">{pendingId ? `Sign off ${blocks.find(b => b.id === pendingId)?.name}` : \"Confirm\"}</n>\n            <AlertDialogDescription className=\"text-[#979795] font-['Montserrat']\">\n              The block will be activated and sent to the athlete.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <Button\n              variant=\"outline\"\n              className=\"border-[#292928] text-[#979795] hover:bg-[#1a1a19]\"\n              onClick={() => setOpenSignOff(false)}\n            >\n              Cancel\n            </Button>\n            <Button\n              className=\"bg-[#e5e4e1] text black\"\n              onClick={async () => {\n                if (!pendingId) return;\n                try {\n                  const res = await fetch(`/api/blocks/${pendingId}/sign-off`, { method: \"POST\" });\n                  setOpenSignOff(false);\n                } catch (e) {\n                  //\n                }\n              }}\n            >\n              Sign off\n            </Button>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n*** End Patch"}githubusercontent.com/killed?token=AJvNz7979f45f4f10_0f3c0ba096b1f84d48e882b8c5f7d2f49319159a92f3f1Bc8wmNw==[INVALID_JSON] Couldn't parse JSON: Unterminated string starting at: line 8 column 306 (char 3549) in json.decoder.py:358: "Failed to decode JSON object: Expecting value: line 8 column 306 (char 3549)" in "__init__"

